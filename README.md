# Meshcore Analyzer

Анализатор пакетов для [MeshCore](https://github.com/meshcore-dev/MeshCore) Observer. Подключается к ноде Room Server по серийному порту, в реальном времени читает радиопакеты и выводит статистику по узлам mesh-сети.

## Возможности

- **Исходящие соседи через API** — получение данных из [MeshCoreTel](https://meshcoretel.ru) без отправки сообщений в каналы (`--api`)
- **Статистика по узлам** — RX/TX, средние SNR и RSSI, ошибки, счётчик хопов
- **Таблица входящих соседей** — кто доставляет пакеты ретранслятору (->RPT) и наблюдателю (->OBS), с процентным соотношением
- **Таблица исходящих соседей** — через кого уходят пакеты от ретранслятора (API или ответы ботов)
- **Рекорд хопов** — пакет с максимальным числом хопов, его маршрут и расшифровка (тип, канал, имя ноды)
- **Дешифрование каналов** — расшифровка групповых сообщений (GRP_TXT/GRP_DATA) публичных каналов (AES-128-ECB)
- **Автоматическое переподключение** — при потере USB-соединения ждёт возвращения порта и продолжает работу
- **Сохранение статистики** — накопленные данные сохраняются в `meshcore-stats.json` между запусками
- **Декодирование RAW-пакетов** — парсинг заголовка MeshCore v1: route type, payload type, path
- **Реальный режим** — пакеты отображаются по мере поступления (опция `-v`)
- **Цветовая раскраска** — свои ноды, ретрансляторы, broadcast и исходящие соседи визуально различаются

## Требования

- Python 3.10+
- [uv](https://docs.astral.sh/uv/)
- [pyserial](https://pypi.org/project/pyserial/)
- [pycryptodome](https://pypi.org/project/pycryptodome/) — для расшифровки групповых сообщений (опционально)
- Нода MeshCore Room Server с функцией Observer, подключённая по USB

## Установка

```bash
uv venv
uv pip install pyserial pycryptodome
```

## Настройка

В начале файла `meshcore-analyzer.py` настройте константы:

```python
PORT = '/dev/cu.usbmodemXXXX'   # серийный порт ноды (ls /dev/cu.usb*)
NODE_PREFIX = '10'               # префикс hex-адресов ваших нод-компаньонов
REPEATER_PREFIX = '33'           # префикс hex-адресов ваших ретрансляторов
CYCLE_TIME = 60                  # интервал вывода статистики (секунды)

# Известные публичные каналы для расшифровки
KNOWN_CHANNEL_NAMES = [
    'Public',
    '#connections',
    '#robot',
    ...
]
```

Ключи каналов вычисляются автоматически: `SHA256(имя)[:16]`. Добавьте свои каналы в список.

Перед запуском отключите веб-консоль (flasher.meshcore.dev) от серийного порта.

## Использование

```bash
# Исходящие соседи через API MeshCoreTel (рекомендуемый способ)
uv run meshcore-analyzer.py -vn --api

# Все отчёты + API
uv run meshcore-analyzer.py -vn --hops --api

# Отслеживать соседей другого ретранслятора
uv run meshcore-analyzer.py -n --api --repeater A7

# Накопительная статистика по узлам (по умолчанию)
uv run meshcore-analyzer.py

# Указать порт
uv run meshcore-analyzer.py -p /dev/cu.usbmodem1234

# Сбросить накопленную статистику
uv run meshcore-analyzer.py --reset
```

## Опции

| Опция | Описание |
|-------|----------|
| `-v`, `--verbose` | Выводить каждый пакет в реальном времени |
| `-o`, `--original` | Накопительная статистика по узлам (RX/TX/SNR/RSSI) |
| `-n`, `--neighbors` | Таблицы входящих и исходящих соседей |
| `--hops` | Пакет-рекордсмен по числу хопов |
| `--api` | Получать исходящих соседей из API meshcoretel.ru |
| `--repeater XX` | Префикс ретранслятора для поиска через API (по умолчанию `33`) |
| `--bots` | Искать исходящих соседей через ответы ботов в каналах |
| `-p`, `--port` | Серийный порт Observer-ноды (по умолчанию из константы PORT) |
| `--reset` | Сбросить сохранённую статистику и начать с нуля |

Если ни `-o`, `-n`, `--hops` не указаны — показывается `-o` по умолчанию.

## Цвета в таблицах

- **Зелёный** — ноды-компаньоны (префикс `NODE_PREFIX`)
- **Голубой** — ретрансляторы (префикс `REPEATER_PREFIX`), пакеты из API `[API]`
- **Жёлтый жирный** — широковещательные пакеты (BCAST)
- **Магента** — сообщения с информацией об исходящих соседях (от ботов)
- Без цвета — остальные узлы

## Протокол MeshCore

Скрипт декодирует пакеты по [спецификации MeshCore v1](https://github.com/meshcore-dev/MeshCore/blob/main/docs/packet_format.md):

```
[header 1B][transport_codes 4B (опц.)][path_length 1B][path NB][payload]
```

Поддерживаемые типы пакетов: REQ, RESPONSE, TXT_MSG, ACK, ADVERT, GRP_TXT, GRP_DATA, ANON_REQ, PATH, TRACE, MULTIPART, CONTROL.

## Лицензия

MIT
